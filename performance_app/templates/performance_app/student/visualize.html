{% extends 'performance_app/base.html' %}

{% block title %}Data Visualization - Student Performance Prediction{% endblock %}
{% block header %}Data Visualization Dashboard{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Performance Analytics</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    Visualize student performance patterns and identify trends using interactive charts.
                    Total Students: <strong>{{ total_students }}</strong>
                </p>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button onclick="refreshCharts()" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> Refresh Charts
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Distribution Chart -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Performance Distribution</h5>
            {% if charts.performance_chart %}
                <img src="data:image/png;base64,{{ charts.performance_chart }}" 
                     alt="Performance Distribution Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No performance data available</p>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Risk Status Distribution</h5>
            {% if charts.risk_chart %}
                <img src="data:image/png;base64,{{ charts.risk_chart }}" 
                     alt="Risk Status Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No risk data available</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Score Distribution Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Attendance Distribution</h5>
            {% if charts.attendance_chart %}
                <img src="data:image/png;base64,{{ charts.attendance_chart }}" 
                     alt="Attendance Distribution Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No attendance data available</p>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Assignment Score Distribution</h5>
            {% if charts.assignment_chart %}
                <img src="data:image/png;base64,{{ charts.assignment_chart }}" 
                     alt="Assignment Score Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No assignment data available</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Scatter Plot -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h5>Attendance vs Assignment Score</h5>
            {% if charts.scatter_chart %}
                <img src="data:image/png;base64,{{ charts.scatter_chart }}" 
                     alt="Scatter Plot Chart" 
                     style="width: 100%; height: 300px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-scatter fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No correlation data available</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Time Analysis -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Time Spent Analysis</h5>
            {% if charts.time_chart %}
                <img src="data:image/png;base64,{{ charts.time_chart }}" 
                     alt="Time Spent Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No time data available</p>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>Quiz Score Analysis</h5>
            {% if charts.quiz_chart %}
                <img src="data:image/png;base64,{{ charts.quiz_chart }}" 
                     alt="Quiz Score Chart" 
                     style="width: 100%; height: 250px; object-fit: contain;">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No quiz data available</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if total_students == 0 %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-chart-bar fa-4x text-muted mb-4"></i>
                <h4 class="text-muted">No Data Available</h4>
                <p class="text-muted">Add students and run predictions to see visualizations</p>
                <div class="mt-4">
                    <a href="{% url 'upload_csv' %}" class="btn btn-primary me-2">
                        <i class="fas fa-file-upload"></i> Upload CSV
                    </a>
                    <a href="{% url 'add_student' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-user-plus"></i> Add Student
                    </a>
                    <a href="{% url 'predict_performance' %}" class="btn btn-success">
                        <i class="fas fa-brain"></i> Run Predictions
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Function to refresh charts by reloading the page
function refreshCharts() {
    location.reload();
}

// Show loading indicator while charts are being generated
document.addEventListener('DOMContentLoaded', function() {
    // Add loading indicators for any missing charts
    const chartContainers = document.querySelectorAll('.chart-container');
    chartContainers.forEach(container => {
        const img = container.querySelector('img');
        if (!img) {
            // Already has placeholder
        }
    });
    
    // Check if we have any charts at all
    const hasCharts = document.querySelectorAll('.chart-container img').length > 0;
    if (!hasCharts && {{ total_students }} > 0) {
        // Show warning if there are students but no charts
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning alert-dismissible fade show';
        alertDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Charts not generated!</strong> Run performance predictions first to generate charts.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.row.mb-4 .card-body').appendChild(alertDiv);
    }
});
</script>

<style>
.chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-height: 350px;
    position: relative;
    display: flex;
    flex-direction: column;
}

.chart-container h5 {
    margin-bottom: 20px;
    color: #333;
    font-weight: 600;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
}

.chart-container img {
    flex: 1;
    object-fit: contain;
    max-height: 280px;
}

.chart-container .text-center {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
</style>
{% endblock %}